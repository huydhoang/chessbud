const a={waitForInputStart:0,pieceClickedThreshold:1,clickTo:2,secondClickThreshold:3,dragTo:4,clickDragTo:5,moveDone:6,reset:7},v={secondClick:"secondClick",movedOutOfBoard:"movedOutOfBoard",draggedBack:"draggedBack",clickedAnother:"clickedAnother"},y=4;class x{constructor(e,t,s,r){this.view=e,this.chessboard=e.chessboard,this.moveStartCallback=t,this.moveDoneCallback=s,this.moveCanceledCallback=r,this.setMoveInputState(a.waitForInputStart)}setMoveInputState(e,t=void 0){const s=this.moveInputState;this.moveInputState=e;switch(e){case a.waitForInputStart:break;case a.pieceClickedThreshold:if(a.waitForInputStart!==s&&a.clickTo!==s)throw new Error("moveInputState");if(this.pointerMoveListener&&(removeEventListener(this.pointerMoveListener.type,this.pointerMoveListener),this.pointerMoveListener=void 0),this.pointerUpListener&&(removeEventListener(this.pointerUpListener.type,this.pointerUpListener),this.pointerUpListener=void 0),this.startIndex=t.index,this.endIndex=void 0,this.movedPiece=t.piece,this.updateStartEndMarkers(),this.startPoint=t.point,!this.pointerMoveListener&&!this.pointerUpListener)if(t.type==="mousedown")this.pointerMoveListener=this.onPointerMove.bind(this),this.pointerMoveListener.type="mousemove",addEventListener("mousemove",this.pointerMoveListener),this.pointerUpListener=this.onPointerUp.bind(this),this.pointerUpListener.type="mouseup",addEventListener("mouseup",this.pointerUpListener);else if(t.type==="touchstart")this.pointerMoveListener=this.onPointerMove.bind(this),this.pointerMoveListener.type="touchmove",addEventListener("touchmove",this.pointerMoveListener),this.pointerUpListener=this.onPointerUp.bind(this),this.pointerUpListener.type="touchend",addEventListener("touchend",this.pointerUpListener);else throw Error("event type");else throw Error("_pointerMoveListener or _pointerUpListener");break;case a.clickTo:this.draggablePiece&&(h.removeElement(this.draggablePiece),this.draggablePiece=void 0),s===a.dragTo&&this.view.setPieceVisibility(t.index);break;case a.secondClickThreshold:if(a.clickTo!==s)throw new Error("moveInputState");this.startPoint=t.point;break;case a.dragTo:if(a.pieceClickedThreshold!==s)throw new Error("moveInputState");this.view.chessboard.state.inputEnabled&&(this.view.setPieceVisibility(t.index,!1),this.createDraggablePiece(t.piece));break;case a.clickDragTo:if(a.secondClickThreshold!==s)throw new Error("moveInputState");this.view.chessboard.state.inputEnabled&&(this.view.setPieceVisibility(t.index,!1),this.createDraggablePiece(t.piece));break;case a.moveDone:if([a.dragTo,a.clickTo,a.clickDragTo].indexOf(s)===-1)throw new Error("moveInputState");if(this.endIndex=t.index,this.endIndex&&this.moveDoneCallback(this.startIndex,this.endIndex)){const r=this.chessboard.state.squares.slice(0);this.chessboard.state.setPiece(this.startIndex,void 0),this.chessboard.state.setPiece(this.endIndex,this.movedPiece),s===a.clickTo?(this.updateStartEndMarkers(),this.view.animatePieces(r,this.chessboard.state.squares.slice(0),()=>{this.setMoveInputState(a.reset)})):this.view.drawPieces(this.chessboard.state.squares).then(()=>{this.setMoveInputState(a.reset)})}else this.view.drawPiecesDebounced().then(()=>{this.setMoveInputState(a.reset)});break;case a.reset:this.startIndex&&!this.endIndex&&this.movedPiece&&this.chessboard.state.setPiece(this.startIndex,this.movedPiece),this.startIndex=void 0,this.endIndex=void 0,this.movedPiece=void 0,this.updateStartEndMarkers(),this.draggablePiece&&(h.removeElement(this.draggablePiece),this.draggablePiece=void 0),this.pointerMoveListener&&(removeEventListener(this.pointerMoveListener.type,this.pointerMoveListener),this.pointerMoveListener=void 0),this.pointerUpListener&&(removeEventListener(this.pointerUpListener.type,this.pointerUpListener),this.pointerUpListener=void 0),this.setMoveInputState(a.waitForInputStart);break;default:throw Error(`moveInputState ${e}`)}}createDraggablePiece(e){if(this.draggablePiece)throw Error("draggablePiece exists");this.draggablePiece=h.createSvg(document.body),this.draggablePiece.classList.add("cm-chessboard-draggable-piece"),this.draggablePiece.setAttribute("width",this.view.squareWidth),this.draggablePiece.setAttribute("height",this.view.squareHeight),this.draggablePiece.setAttribute("style","pointer-events: none"),this.draggablePiece.name=e;const t=this.chessboard.props.sprite.cache?"":this.chessboard.props.sprite.url,s=h.addElement(this.draggablePiece,"use",{href:`${t}#${e}`}),r=this.view.squareHeight/this.chessboard.props.sprite.size,i=this.draggablePiece.createSVGTransform();i.setScale(r,r),s.transform.baseVal.appendItem(i)}moveDraggablePiece(e,t){this.draggablePiece.setAttribute("style",`pointer-events: none; position: absolute; left: ${e-this.view.squareHeight/2}px; top: ${t-this.view.squareHeight/2}px`)}onPointerDown(e){if(e.type==="mousedown"&&e.button===0||e.type==="touchstart"){const t=e.target.getAttribute("data-index"),s=this.view.getPiece(t);let r,i;if(s&&(r=s.getAttribute("data-piece"),i=r?r.substr(0,1):void 0,(i==="w"&&this.chessboard.state.inputWhiteEnabled||i==="b"&&this.chessboard.state.inputBlackEnabled)&&e.preventDefault()),t&&(this.moveInputState!==a.waitForInputStart||this.chessboard.state.inputWhiteEnabled&&i==="w"||this.chessboard.state.inputBlackEnabled&&i==="b")){let n;if(e.type==="mousedown"?n={x:e.clientX,y:e.clientY}:e.type==="touchstart"&&(n={x:e.touches[0].clientX,y:e.touches[0].clientY}),this.moveInputState===a.waitForInputStart&&r&&this.moveStartCallback(t))this.setMoveInputState(a.pieceClickedThreshold,{index:t,piece:r,point:n,type:e.type});else if(this.moveInputState===a.clickTo)if(t===this.startIndex)this.setMoveInputState(a.secondClickThreshold,{index:t,piece:r,point:n,type:e.type});else{const o=this.chessboard.getPiece(p[t]),c=o?o.substr(0,1):void 0,d=this.chessboard.getPiece(p[this.startIndex]),f=d?d.substr(0,1):void 0;i&&f===c?(this.moveCanceledCallback(v.clickedAnother,t),this.moveStartCallback(t)?this.setMoveInputState(a.pieceClickedThreshold,{index:t,piece:o,point:n,type:e.type}):this.setMoveInputState(a.reset)):this.setMoveInputState(a.moveDone,{index:t})}}}}onPointerMove(e){let t,s,r,i,n;if(e.type==="mousemove"?(r=e.clientX,i=e.clientY,t=e.pageX,s=e.pageY,n=e.target):e.type==="touchmove"&&(r=e.touches[0].clientX,i=e.touches[0].clientY,t=e.touches[0].pageX,s=e.touches[0].pageY,n=document.elementFromPoint(r,i)),this.moveInputState===a.pieceClickedThreshold||this.moveInputState===a.secondClickThreshold)(Math.abs(this.startPoint.x-r)>y||Math.abs(this.startPoint.y-i)>y)&&(this.moveInputState===a.secondClickThreshold?this.setMoveInputState(a.clickDragTo,{index:this.startIndex,piece:this.movedPiece}):this.setMoveInputState(a.dragTo,{index:this.startIndex,piece:this.movedPiece}),this.view.chessboard.state.inputEnabled&&this.moveDraggablePiece(t,s));else if(this.moveInputState===a.dragTo||this.moveInputState===a.clickDragTo||this.moveInputState===a.clickTo){if(n&&n.getAttribute&&n.parentElement===this.view.boardGroup){const o=n.getAttribute("data-index");o!==this.startIndex&&o!==this.endIndex?(this.endIndex=o,this.updateStartEndMarkers()):o===this.startIndex&&this.endIndex!==void 0&&(this.endIndex=void 0,this.updateStartEndMarkers())}else this.endIndex!==void 0&&(this.endIndex=void 0,this.updateStartEndMarkers());this.view.chessboard.state.inputEnabled&&(this.moveInputState===a.dragTo||this.moveInputState===a.clickDragTo)&&this.moveDraggablePiece(t,s)}}onPointerUp(e){let t;if(e.type==="mouseup"?t=e.target:e.type==="touchend"&&(t=document.elementFromPoint(e.changedTouches[0].clientX,e.changedTouches[0].clientY)),t&&t.getAttribute){const s=t.getAttribute("data-index");s?this.moveInputState===a.dragTo||this.moveInputState===a.clickDragTo?this.startIndex===s?this.moveInputState===a.clickDragTo?(this.chessboard.state.setPiece(this.startIndex,this.movedPiece),this.view.setPieceVisibility(this.startIndex),this.moveCanceledCallback(v.draggedBack,s),this.setMoveInputState(a.reset)):this.setMoveInputState(a.clickTo,{index:s}):this.setMoveInputState(a.moveDone,{index:s}):this.moveInputState===a.pieceClickedThreshold?this.setMoveInputState(a.clickTo,{index:s}):this.moveInputState===a.secondClickThreshold&&(this.setMoveInputState(a.reset),this.moveCanceledCallback(v.secondClick,s)):this.view.drawPiecesDebounced().then(()=>{this.setMoveInputState(a.reset),this.moveCanceledCallback(v.movedOutOfBoard,void 0)})}else this.view.drawPiecesDebounced().then(()=>{this.setMoveInputState(a.reset)})}updateStartEndMarkers(){this.chessboard.props.style.moveMarker&&this.chessboard.state.removeMarkers(void 0,this.chessboard.props.style.moveMarker),this.chessboard.props.style.hoverMarker&&this.chessboard.state.removeMarkers(void 0,this.chessboard.props.style.hoverMarker),this.chessboard.props.style.moveMarker&&(this.startIndex&&this.chessboard.state.addMarker(this.startIndex,this.chessboard.props.style.moveMarker)),this.chessboard.props.style.hoverMarker&&(this.endIndex&&this.chessboard.state.addMarker(this.endIndex,this.chessboard.props.style.hoverMarker)),this.view.drawMarkersDebounced()}reset(){this.setMoveInputState(a.reset)}destroy(){this.reset()}}const l={move:0,appear:1,disappear:2};class E{constructor(e,t,s,r,i){this.view=e,t&&s&&(this.animatedElements=this.createAnimation(t,s),this.duration=r,this.callback=i,this.frameHandle=requestAnimationFrame(this.animationStep.bind(this)))}seekChanges(e,t){const s=[],r=[],i=[];for(let n=0;n<64;n++){const o=e[n],c=t[n];c!==o&&(c&&s.push({piece:c,index:n}),o&&r.push({piece:o,index:n}))}return s.forEach(n=>{let o=8,c;r.forEach(d=>{if(n.piece===d.piece){const f=this.squareDistance(n.index,d.index);f<o&&(c=d,o=f)}}),c?(r.splice(r.indexOf(c),1),i.push({type:l.move,piece:n.piece,atIndex:c.index,toIndex:n.index})):i.push({type:l.appear,piece:n.piece,atIndex:n.index})}),r.forEach(n=>{i.push({type:l.disappear,piece:n.piece,atIndex:n.index})}),i}createAnimation(e,t){const s=this.seekChanges(e,t),r=[];return s.forEach(i=>{const n={type:i.type};switch(i.type){case l.move:n.element=this.view.getPiece(i.atIndex),n.atPoint=this.view.squareIndexToPoint(i.atIndex),n.toPoint=this.view.squareIndexToPoint(i.toIndex);break;case l.appear:n.element=this.view.drawPiece(i.atIndex,i.piece),n.element.style.opacity=0;break;case l.disappear:n.element=this.view.getPiece(i.atIndex);break}r.push(n)}),r}animationStep(e){this.startTime||(this.startTime=e);const t=e-this.startTime;if(t<=this.duration)this.frameHandle=requestAnimationFrame(this.animationStep.bind(this));else{cancelAnimationFrame(this.frameHandle),this.callback();return}const s=Math.min(1,t/this.duration),r=s<.5?2*s*s:-1+(4-2*s)*s;this.animatedElements.forEach(i=>{if(i.element)switch(i.type){case l.move:i.element.transform.baseVal.removeItem(0);const n=this.view.svg.createSVGTransform();n.setTranslate(i.atPoint.x+(i.toPoint.x-i.atPoint.x)*r,i.atPoint.y+(i.toPoint.y-i.atPoint.y)*r),i.element.transform.baseVal.appendItem(n);break;case l.appear:i.element.style.opacity=r;break;case l.disappear:i.element.style.opacity=1-r;break}else console.warn("animatedItem has no element",i)})}squareDistance(e,t){const s=e%8,r=Math.floor(e/8),i=t%8,n=Math.floor(t/8);return Math.max(Math.abs(n-r),Math.abs(i-s))}}const p=["a1","b1","c1","d1","e1","f1","g1","h1","a2","b2","c2","d2","e2","f2","g2","h2","a3","b3","c3","d3","e3","f3","g3","h3","a4","b4","c4","d4","e4","f4","g4","h4","a5","b5","c5","d5","e5","f5","g5","h5","a6","b6","c6","d6","e6","f6","g6","h6","a7","b7","c7","d7","e7","f7","g7","h7","a8","b8","c8","d8","e8","f8","g8","h8"];class C{constructor(e,t){this.animationRunning=!1,this.currentAnimation=void 0,this.chessboard=e,this.moveInput=new x(this,this.moveStartCallback.bind(this),this.moveDoneCallback.bind(this),this.moveCanceledCallback.bind(this)),this.animationQueue=[],e.props.sprite.cache&&this.cacheSprite(),e.props.responsive&&(typeof ResizeObserver!="undefined"?(this.resizeObserver=new ResizeObserver(()=>{this.handleResize()}),this.resizeObserver.observe(this.chessboard.element)):(this.resizeListener=this.handleResize.bind(this),window.addEventListener("resize",this.resizeListener))),this.pointerDownListener=this.pointerDownHandler.bind(this),this.chessboard.element.addEventListener("mousedown",this.pointerDownListener),this.chessboard.element.addEventListener("touchstart",this.pointerDownListener),this.createSvgAndGroups(),this.updateMetrics(),t(this),e.props.responsive&&this.handleResize()}pointerDownHandler(e){this.moveInput.onPointerDown(e)}destroy(){this.moveInput.destroy(),this.resizeObserver&&this.resizeObserver.unobserve(this.chessboard.element),this.resizeListener&&window.removeEventListener("resize",this.resizeListener),this.chessboard.element.removeEventListener("mousedown",this.pointerDownListener),this.chessboard.element.removeEventListener("touchstart",this.pointerDownListener),window.clearTimeout(this.resizeDebounce),window.clearTimeout(this.redrawDebounce),window.clearTimeout(this.drawPiecesDebounce),window.clearTimeout(this.drawMarkersDebounce),h.removeElement(this.svg),this.animationQueue=[],this.currentAnimation&&cancelAnimationFrame(this.currentAnimation.frameHandle)}cacheSprite(){const e="chessboardSpriteCache";if(!document.getElementById(e)){const t=document.createElement("div");t.style.display="none",t.id=e,document.body.appendChild(t);const s=new XMLHttpRequest;s.open("GET",this.chessboard.props.sprite.url,!0),s.onload=function(){t.insertAdjacentHTML("afterbegin",s.response)},s.send()}}createSvgAndGroups(){this.svg&&h.removeElement(this.svg),this.svg=h.createSvg(this.chessboard.element);let e=this.chessboard.props.style.cssClass?this.chessboard.props.style.cssClass:"default";this.svg.setAttribute("class","cm-chessboard border-type-"+this.chessboard.props.style.borderType+" "+e),this.updateMetrics(),this.boardGroup=h.addElement(this.svg,"g",{class:"board"}),this.coordinatesGroup=h.addElement(this.svg,"g",{class:"coordinates"}),this.markersGroup=h.addElement(this.svg,"g",{class:"markers"}),this.piecesGroup=h.addElement(this.svg,"g",{class:"pieces"})}updateMetrics(){this.width=this.chessboard.element.clientWidth,this.height=this.chessboard.element.clientHeight,this.chessboard.props.style.borderType===b.frame?this.borderSize=this.width/25:this.chessboard.props.style.borderType===b.thin?this.borderSize=this.width/320:this.borderSize=0,this.innerWidth=this.width-2*this.borderSize,this.innerHeight=this.height-2*this.borderSize,this.squareWidth=this.innerWidth/8,this.squareHeight=this.innerHeight/8,this.scalingX=this.squareWidth/this.chessboard.props.sprite.size,this.scalingY=this.squareHeight/this.chessboard.props.sprite.size,this.pieceXTranslate=this.squareWidth/2-this.chessboard.props.sprite.size*this.scalingY/2}handleResize(){window.clearTimeout(this.resizeDebounce),this.resizeDebounce=setTimeout(()=>{this.chessboard.props.style.aspectRatio&&(this.chessboard.element.style.height=this.chessboard.element.clientWidth*this.chessboard.props.style.aspectRatio+"px"),(this.chessboard.element.clientWidth!==this.width||this.chessboard.element.clientHeight!==this.height)&&(this.updateMetrics(),this.redraw()),this.svg.setAttribute("width","100%"),this.svg.setAttribute("height","100%")})}redraw(){return new Promise(e=>{window.clearTimeout(this.redrawDebounce),this.redrawDebounce=setTimeout(()=>{this.drawBoard(),this.drawCoordinates(),this.drawMarkers(),this.setCursor()}),this.drawPiecesDebounced(this.chessboard.state.squares).then(e)})}drawBoard(){for(;this.boardGroup.firstChild;)this.boardGroup.removeChild(this.boardGroup.lastChild);if(this.chessboard.props.style.borderType!==b.none){let e=h.addElement(this.boardGroup,"rect",{width:this.width,height:this.height});if(e.setAttribute("class","border"),this.chessboard.props.style.borderType===b.frame){const t=this.borderSize;let s=h.addElement(this.boardGroup,"rect",{x:t,y:t,width:this.width-t*2,height:this.height-t*2});s.setAttribute("class","border-inner")}}for(let e=0;e<64;e++){const t=this.chessboard.state.orientation===u.white?e:63-e,s=(9*t&8)===0?"black":"white",r=`square ${s}`,i=this.squareIndexToPoint(t),n=h.addElement(this.boardGroup,"rect",{x:i.x,y:i.y,width:this.squareWidth,height:this.squareHeight});n.setAttribute("class",r),n.setAttribute("data-index",""+t)}}drawCoordinates(){if(!this.chessboard.props.style.showCoordinates)return;for(;this.coordinatesGroup.firstChild;)this.coordinatesGroup.removeChild(this.coordinatesGroup.lastChild);const e=this.chessboard.props.style.borderType!==b.frame;for(let t=0;t<8;t++){let s=this.borderSize+(17+this.chessboard.props.sprite.size*t)*this.scalingX,r=this.height-this.scalingY*3.5,i="coordinate file";e&&(s=s+this.scalingX*15.5,i+=t%2?" white":" black");const n=h.addElement(this.coordinatesGroup,"text",{class:i,x:s,y:r,style:`font-size: ${this.scalingY*10}px`});this.chessboard.state.orientation===u.white?n.textContent=String.fromCharCode(97+t):n.textContent=String.fromCharCode(104-t)}for(let t=0;t<8;t++){let s=this.borderSize/3.7,r=this.borderSize+25*this.scalingY+t*this.squareHeight,i="coordinate rank";e&&(i+=t%2?" black":" white",this.chessboard.props.style.borderType===b.frame?(s=s+this.scalingX*10,r=r-this.scalingY*15):(s=s+this.scalingX*2,r=r-this.scalingY*15));const n=h.addElement(this.coordinatesGroup,"text",{class:i,x:s,y:r,style:`font-size: ${this.scalingY*10}px`});this.chessboard.state.orientation===u.white?n.textContent=""+(8-t):n.textContent=""+(1+t)}}drawPiecesDebounced(e=this.chessboard.state.squares){return new Promise(t=>{window.clearTimeout(this.drawPiecesDebounce),this.drawPiecesDebounce=setTimeout(()=>{this.drawPieces(e).then(t)})})}drawPieces(e=this.chessboard.state.squares){return new Promise(t=>{const s=Array.from(this.piecesGroup.childNodes);for(let r=0;r<64;r++){const i=e[r];i&&this.drawPiece(r,i)}for(const r of s)this.piecesGroup.removeChild(r);t()})}drawPiece(e,t){const s=h.addElement(this.piecesGroup,"g");s.setAttribute("data-piece",t),s.setAttribute("data-index",e);const r=this.squareIndexToPoint(e),i=this.svg.createSVGTransform();i.setTranslate(r.x,r.y),s.transform.baseVal.appendItem(i);const n=this.chessboard.props.sprite.cache?"":this.chessboard.props.sprite.url,o=h.addElement(s,"use",{href:`${n}#${t}`,class:"piece"}),c=this.svg.createSVGTransform();c.setTranslate(this.pieceXTranslate,0),o.transform.baseVal.appendItem(c);const d=this.svg.createSVGTransform();return d.setScale(this.scalingY,this.scalingY),o.transform.baseVal.appendItem(d),s}setPieceVisibility(e,t=!0){const s=this.getPiece(e);t?s.setAttribute("visibility","visible"):s.setAttribute("visibility","hidden")}getPiece(e){return this.piecesGroup.querySelector(`g[data-index='${e}']`)}drawMarkersDebounced(){window.clearTimeout(this.drawMarkersDebounce),this.drawMarkersDebounce=setTimeout(()=>{this.drawMarkers()},10)}drawMarkers(){for(;this.markersGroup.firstChild;)this.markersGroup.removeChild(this.markersGroup.firstChild);this.chessboard.state.markers.forEach(e=>{this.drawMarker(e)})}drawMarker(e){const t=h.addElement(this.markersGroup,"g");t.setAttribute("data-index",e.index);const s=this.squareIndexToPoint(e.index),r=this.svg.createSVGTransform();r.setTranslate(s.x,s.y),t.transform.baseVal.appendItem(r);const i=this.chessboard.props.sprite.cache?"":this.chessboard.props.sprite.url,n=h.addElement(t,"use",{href:`${i}#${e.type.slice}`,class:"marker "+e.type.class}),o=this.svg.createSVGTransform();return o.setScale(this.scalingX,this.scalingY),n.transform.baseVal.appendItem(o),t}animatePieces(e,t,s){this.animationQueue.push({fromSquares:e,toSquares:t,callback:s}),this.animationRunning||this.nextPieceAnimationInQueue()}nextPieceAnimationInQueue(){const e=this.animationQueue.shift();e!==void 0&&(this.animationRunning=!0,this.currentAnimation=new E(this,e.fromSquares,e.toSquares,this.chessboard.props.animationDuration/(this.animationQueue.length+1),()=>{this.moveInput.draggablePiece?(this.animationRunning=!1,this.nextPieceAnimationInQueue(),e.callback&&e.callback()):this.drawPieces(e.toSquares).then(()=>{this.animationRunning=!1,this.nextPieceAnimationInQueue(),e.callback&&e.callback()})}))}enableMoveInput(e,t=void 0){t===u.white?this.chessboard.state.inputWhiteEnabled=!0:t===u.black?this.chessboard.state.inputBlackEnabled=!0:(this.chessboard.state.inputWhiteEnabled=!0,this.chessboard.state.inputBlackEnabled=!0),this.chessboard.state.inputEnabled=!0,this.moveInputCallback=e,this.setCursor()}disableMoveInput(){this.chessboard.state.inputWhiteEnabled=!1,this.chessboard.state.inputBlackEnabled=!1,this.chessboard.state.inputEnabled=!1,this.moveInputCallback=void 0,this.setCursor()}moveStartCallback(e){return this.moveInputCallback?this.moveInputCallback({chessboard:this.chessboard,type:w.moveStart,square:p[e]}):!0}moveDoneCallback(e,t){return this.moveInputCallback?this.moveInputCallback({chessboard:this.chessboard,type:w.moveDone,squareFrom:p[e],squareTo:p[t]}):!0}moveCanceledCallback(e,t){this.moveInputCallback&&this.moveInputCallback({chessboard:this.chessboard,type:w.moveCanceled,reason:e,square:t?p[t]:void 0})}setCursor(){this.chessboard.initialization.then(()=>{this.chessboard.state&&(this.chessboard.state.inputWhiteEnabled||this.chessboard.state.inputBlackEnabled||this.chessboard.state.squareSelectEnabled?this.boardGroup.setAttribute("class","board input-enabled"):this.boardGroup.setAttribute("class","board"))})}squareIndexToPoint(e){let t,s;return this.chessboard.state.orientation===u.white?(t=this.borderSize+e%8*this.squareWidth,s=this.borderSize+(7-Math.floor(e/8))*this.squareHeight):(t=this.borderSize+(7-e%8)*this.squareWidth,s=this.borderSize+Math.floor(e/8)*this.squareHeight),{x:t,y:s}}}const I="http://www.w3.org/2000/svg";class h{static createSvg(e=void 0){let t=document.createElementNS(I,"svg");return e&&(t.setAttribute("width","100%"),t.setAttribute("height","100%"),e.appendChild(t)),t}static addElement(e,t,s){let r=document.createElementNS(I,t);t==="use"&&(s["xlink:href"]=s.href);for(let i in s)if(s.hasOwnProperty(i))if(i.indexOf(":")!==-1){const n=i.split(":");r.setAttributeNS("http://www.w3.org/1999/"+n[0],n[1],s[i])}else r.setAttribute(i,s[i]);return e.appendChild(r),r}static removeElement(e){e.parentNode.removeChild(e)}}class T{constructor(){this.squares=new Array(64).fill(void 0),this.orientation=void 0,this.markers=[],this.inputWhiteEnabled=!1,this.inputBlackEnabled=!1,this.inputEnabled=!1,this.squareSelectEnabled=!1}setPiece(e,t){this.squares[e]=t}addMarker(e,t){this.markers.push({index:e,type:t})}removeMarkers(e=void 0,t=void 0){!e&&!t?this.markers=[]:this.markers=this.markers.filter(s=>{if(s.type){if(e){if(s.type===t&&e===s.index)return!1}else if(s.type===t)return!1}else if(e===s.index)return!1;return!0})}setPosition(e){if(e){const t=e.replace(/^\s*/,"").replace(/\s*$/,"").split(/\/|\s/);for(let s=0;s<8;s++){const r=t[7-s].replace(/\d/g,i=>{const n=parseInt(i);let o="";for(let c=0;c<n;c++)o+="-";return o});for(let i=0;i<8;i++){const n=r.substr(i,1);let o;n!=="-"&&(n.toUpperCase()===n?o=`w${n.toLowerCase()}`:o=`b${n}`),this.squares[s*8+i]=o}}}}getPosition(){let e=new Array(8).fill("");for(let t=0;t<8;t++){let s=0;for(let r=0;r<8;r++){const i=this.squares[t*8+r];if(!i)s++;else{s>0&&(e[7-t]+=s,s=0);const n=i.substr(0,1),o=i.substr(1,1);n==="w"?e[7-t]+=o.toUpperCase():e[7-t]+=o}}s>0&&(e[7-t]+=s,s=0)}return e.join("/")}squareToIndex(e){const t=e.substr(0,1).charCodeAt(0)-97,s=e.substr(1,1)-1;return 8*s+t}}const u={white:"w",black:"b"},w={moveStart:"moveStart",moveDone:"moveDone",moveCanceled:"moveCanceled"},g={primary:"primary",secondary:"secondary"},b={none:"none",thin:"thin",frame:"frame"},k={frame:{class:"markerFrame",slice:"markerFrame"},square:{class:"markerSquare",slice:"markerSquare"},dot:{class:"markerDot",slice:"markerDot"},circle:{class:"markerCircle",slice:"markerCircle"}},M={wp:"wp",wb:"wb",wn:"wn",wr:"wr",wq:"wq",wk:"wk",bp:"bp",bb:"bb",bn:"bn",br:"br",bq:"bq",bk:"bk"},S="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",P="8/8/8/8/8/8/8/8";class q{constructor(e,t={}){if(!e)throw new Error("container element is "+e);this.element=e;let s={position:"empty",orientation:u.white,style:{cssClass:"default",showCoordinates:!0,borderType:b.thin,aspectRatio:1,moveMarker:k.frame,hoverMarker:k.frame},responsive:!0,animationDuration:300,sprite:{url:"./assets/images/chessboard-sprite-staunty.svg",size:40,cache:!0}};this.props={},Object.assign(this.props,s),Object.assign(this.props,t),this.props.sprite=s.sprite,this.props.style=s.style,t.sprite&&Object.assign(this.props.sprite,t.sprite),t.style&&Object.assign(this.props.style,t.style),this.props.style.aspectRatio&&(this.element.style.height=this.element.offsetWidth*this.props.style.aspectRatio+"px"),this.state=new T,this.state.orientation=this.props.orientation,this.initialization=new Promise(r=>{this.view=new C(this,i=>{this.props.position==="start"?this.state.setPosition(S):this.props.position==="empty"||this.props.position===void 0?this.state.setPosition(P):this.state.setPosition(this.props.position),i.redraw().then(()=>{r()})})})}setPiece(e,t){return new Promise(s=>{this.initialization.then(()=>{this.state.setPiece(this.state.squareToIndex(e),t),this.view.drawPiecesDebounced(this.state.squares).then(s)})})}getPiece(e){return this.state.squares[this.state.squareToIndex(e)]}setPosition(e,t=!0){const s=new Promise(r=>{this.initialization.then(()=>{e==="start"?e=S:e==="empty"&&(e=P);const i=this.state.getPosition(),n=e.split(" "),o=n[0];if(o!==i){this.previousPromise=s;const c=this.state.squares.slice(0);this.state.setPosition(e),t?this.view.animatePieces(c,this.state.squares.slice(0),()=>{r()}):this.view.drawPiecesDebounced(this.state.squares).then(r)}else this.previousPromise?this.previousPromise.then(()=>{r()}):r()})});return s}getPosition(){return this.state.getPosition()}addMarker(e,t){t||console.error("Error addMarker(), type is "+t),this.state.addMarker(this.state.squareToIndex(e),t),this.view.drawMarkersDebounced()}getMarkers(e=void 0,t=void 0){const s=[];return this.state.markers.forEach(r=>{const i=p[r.index];(!e&&(!t||t===r.type)||!t&&e===i||t===r.type&&e===i)&&s.push({square:p[r.index],type:r.type})}),s}removeMarkers(e=void 0,t=void 0){const s=e?this.state.squareToIndex(e):void 0;this.state.removeMarkers(s,t),this.view.drawMarkersDebounced()}setOrientation(e){return this.state.orientation=e,this.view.redraw()}getOrientation(){return this.state.orientation}destroy(){return new Promise(e=>{this.initialization.then(()=>{this.view.destroy(),this.view=void 0,this.state=void 0,this.squareSelectListener&&(this.element.removeEventListener("contextmenu",this.squareSelectListener),this.element.removeEventListener("mouseup",this.squareSelectListener),this.element.removeEventListener("touchend",this.squareSelectListener)),e()})})}enableMoveInput(e,t=void 0){this.view.enableMoveInput(e,t)}disableMoveInput(){this.view.disableMoveInput()}enableContextInput(e){console.warn("enableContextInput() is deprecated, use enableSquareSelect()"),this.enableSquareSelect(function(t){t.type===g.secondary&&e(t)})}disableContextInput(){this.disableSquareSelect()}enableSquareSelect(e){if(this.squareSelectListener){console.warn("squareSelectListener already existing");return}this.squareSelectListener=function(t){const s=t.target.getAttribute("data-index");if(t.type==="contextmenu"){t.preventDefault();return}e({chessboard:this,type:t.button===2?g.secondary:g.primary,square:p[s]})},this.element.addEventListener("contextmenu",this.squareSelectListener),this.element.addEventListener("mouseup",this.squareSelectListener),this.element.addEventListener("touchend",this.squareSelectListener),this.state.squareSelectEnabled=!0,this.view.setCursor()}disableSquareSelect(){this.element.removeEventListener("contextmenu",this.squareSelectListener),this.element.removeEventListener("mouseup",this.squareSelectListener),this.element.removeEventListener("touchend",this.squareSelectListener),this.squareSelectListener=void 0,this.state.squareSelectEnabled=!1,this.view.setCursor()}}export{b as BORDER_TYPE,u as COLOR,q as Chessboard,P as FEN_EMPTY_POSITION,S as FEN_START_POSITION,w as INPUT_EVENT_TYPE,k as MARKER_TYPE,M as PIECE,g as SQUARE_SELECT_TYPE};export default null;
